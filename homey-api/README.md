# homey-api

Backend written in Flask for [homey dashboard](https://github.com/vlfldr/homey). Mostly used to fetch API data.

## Documentation
The backend runs on port 9101 by default. Weather location, timezone, and API endpoints can be configured in `.env`.

*Routes marked deprecated are now handled internally to avoid unnecessarily transmitting credentials.*

### dockerList
Returns a list of all running Docker containers and their uptime as reported by the local Docker instance's API.

    [
        {
            "id": "63a14a49d...",
            "name": "nextcloud",
            "status": "running",
            "uptime": "up 6 days"
        },
        {
            "id": "acc58b83c...",
            "name": "homey-api",
            "status": "exited",
            "uptime": "Exited (0) About an hour ago"
        },
        ...
    ]

### dockerControl
Executes specified operation on specified container through the Docker API. POST data should be formated as follows:

    "name": "nextcloud",
    "operation": "pause | unpause | start | stop | restart | kill | info"

Returns `Error` if the container is not found or the operation fails. Returns `Success` if successful. `info` returns detailed information identical to the output of `docker inspect <container>`.

*Note: Portainer and Docker backends are interchangeable.*

### portainerList **GET**
Returns a list of all running docker containers and their uptime as reported by Portainer. Will attempt to `portainerAuth` if not already authenticated. 

    [
        {
            "id": "63a14a49d...",
            "name": "nextcloud",
            "status": "running",
            "uptime": "up 6 days"
        },
        {
            "id": "acc58b83c...",
            "name": "homey-api",
            "status": "exited",
            "uptime": "Exited (0) About an hour ago"
        },
        ...
    ]

### portainerControl **POST**
Proxies requests through to Docker API. Will attempt to `portainerAuth` if not already authenticated. For more information, see **dockerControl**.

### portainerAuth
Attempt to authenticate the server with a local Portainer API. Specify host, port, username, and password in `.env`. Returns `True` if successful or already authenticated and `False` if the Portainer API is unreachable or login information incorrect. *Deprecated*

### floodStats **GET**
Gets current upload/download speed and daily upload/downloaded data as reported by Flood. Will attempt to `floodAuth` if not already authenticated.

    "dailyDownloaded": "888mb",
    "dailyUploaded": "3.8gb",
    "downSpeed": "2.3mb/s",
    "upSpeed": "154kb/s"

### floodNotifications **GET**
Gets a list of all 'torrent finished' notifications from Flood. Each notification contains the torrent's name and the time it finished downloading:

    [
        {
            "msg": "bladee - The Fool (2021) - WEB FLAC",
            "time": "12/07 8:08 PM"
        },
        {
            "msg": "debian-11.2.0-amd64-DVD-1.iso",
            "time": "12/08 11:23 AM"
        },
        ...
    ]

### floodAuth
Attempts to authenticate the server with a local Flood API. Specify host, port, username, and password in `.env`. Returns `True` if successful or already authenticated and `False` if the Flood API is unreachable or login information incorrect. *Deprecated*

### systemInfo **GET**
Reads `homey-api/config/local_machine_data.json` (also mounted in Docker volume by default). This file is generated by `monitorSystem.py` and allows homey to monitor the host from inside a container. Options can be configured within the script.

    "hostname": "grokbox",
    "uptime": "1 day, 4 hours, 0 minutes",
    "cpu": 0.9,
    "ram": {
        "total": 16769,
        "free": 9837,
        "used": 6553,
        "percent_used": 41.3
    }
    "disks": [
        {
            "label": "/",
            "total": 115,
            "used": 52,
            "free": 57,
            "percent_used": 45
        },
        {
            "label": "/mnt/storage",
            "total": 2048,
            "used": 512,
            "free": 1532,
            "percent_used": 25
        },
        ...
    ]

### checkServices **GET**
Queries each configured service's URL and reports whether it is online or offline. Call `/readFrontendConfig` once beforehand to assign services.

    [
        {
            "name": "Portainer",
            "up": true
        },
        {
            "name": "Flood",
            "up": true
        },
        {
            "name": "Navidrome",
            "up": true
        },
        ...
    ]

### writeFrontendConfig **POST**
Saves user configuration changes made from the browser to `homey-api/config/config.yml`. For valid input format see `config.yml.example`. Returns `Error` or `Success`.

### readFrontendConfig **GET**
Reads `homey-api/config/config.yml`, parses the YAML into a json object, and returns it. Does not perform validation - typos and malformed options may have unexpected effects. Passes list of services to service checker for initialization. Returns a JSON configuration object or `Error`.

### weatherWeekly **GET**
Get 7 days of daily weather forecast data, beginning at the current day. Each day is formatted as follows:

    "day": "2021-12-05",
    "precipitation": 0.1,
    "temp_max": 35.8,
    "temp_min": 30.5,
    "weather_type": "Light Snow Showers"

### weatherHourly **GET**
Get 168 hours (7 days) of hourly weather forecast data, beginning at midnight of the current day in the configured timezone. Each hour is formatted as follows:

    "precipitation": 0.002,
    "snow_depth": 0,
    "temp": 42.8,
    "time": "12/06 6 AM",
    "weather_type": "Overcast"

### weatherHourly/\<YYYYMMDD\> **GET**
Get 24 hours of hourly forecast data, beginning at midnight of the specified day in the configured timezone. **The day must be in the forecast (i.e. current day - 7 days in the future).** If the current day is specified, the 24 hour window will begin at the start of the current hour.

    "precipitation": 0.048,
    "snow_depth": 0,
    "temp": 51.7,
    "time": "4 PM",
    "weather_type": "Light Rain"

### uploadIcon **POST**
Uploads a PNG or JPEG service icon from the browser to `./config/icons` (also mounted in Docker volume by default). If not running in Docker, will attempt to save directly to frontend at `../homey/public/data/icons`. Returns `Success` or `Error`.